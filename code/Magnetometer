#include<Wire.h>
#include<Math.h>

#define HMC5883_ADDRESS 0x1E

#define MODE_REGEISTER_ADDRESS 0x02
#define DECLINATION_ANGLE 0.5f

#define NUM_AXIS 3

#define XAXIS 0
#define YAXIS 1
#define ZAXIS 2

#define scaleVal 0.00091743119f

float heading; 
int16_t magnetoRawVal[NUM_AXIS];
float magnetoScaledVal[NUM_AXIS];

void getMagnetoRawVal(){
   Wire.beginTransmission(HMC5883_ADDRESS);
   Wire.write(0x03);
   Wire.endTransmission(false);
   
   Wire.requestFrom(HMC,6,true);
   
   magnetoRawVal[XAXIS]=Wire.read()<<8|Wire.read();
   magnetoRawVal[YAXIS]=Wire.read()<<8|Wire.read();
   magnetoRawVal[ZAXIS]=Wire.read()<<8|Wire.read();
}


void initMagneto(){
  Wire.begin();
  
  Wire.beginTransmission(HMC5883_ADDRESS);
  Wire.write(MODE_ADDRESS);
  Wire.write(0x00);//continuous mode enable
  Wire.endTransmission(true);
  
  Wire.beginTransmission(HMC5883_ADDRESS);
  Wire.write(0x01);
  Wire.write(0x20);//setting range to +/- 1.3 gauss.
  Wire.endTransmission(true);  
}

void getScaledVal(){
    magnetoScaledVal[XAXIS]=(float)magnetoRawVal[XAXIS]*scaleVal;
    magnetoScaledVal[YAXIS]=(float)magnetoRawVal[YAXIS]*scaleVal;
    magnetoScaledVal[ZAXIS]=(float)magnetoRawVal[ZAXIS]*scaleVal;
}

void getHeading(){
  heading=atan2(magnetoScaledVal[YAXIS],magnetoScaledVal[XAXIS])*180/PI;
 
  heading+=declination_Angle;
  
  if(heading<-180)
   heading+=360;
  if(heading>180)
   heading-=360;
}
