#include<Wire.h>
#include<Math.h>
#define HMC5883_add 0x1E
#define Mode_add 0x02
#define declination_angle 0.087
#define AXIS 3
#define XAXIS 0
#define YAXIS 1
#define ZAXIS 2
#define scaleVal 1.0

double heading; 
int16_t Magnetometer_RawVal[AXIS];
int16_t Magnetometer_ScaledVal[AXIS];

void getRawVal(){
   Wire.beginTransmission(HMC5883_add);
   Wire.write(0x03);
   Wire.endTransmission(false);
   Wire.requestFrom(HMC,6,true);
   
   Magnetometer_RawVal[XAXIS]=Wire.read()<<8|Wire.read();
   Magnetometer_RawVal[YAXIS]=Wire.read()<<8|Wire.read();
   Magnetometer_RawVal[ZAXIS]=Wire.read()<<8|Wire.read();
}


void init_Magnetometer(){
  Wire.begin();
  Wire.beginTransmission(HMC5883_add);
  Wire.write(Mode_add);
  Wire.write(0x00);//continuos mode enable
  Wire.endTransmission(true);
  Wire.beginTransmission(HMC5883_add);
  Wire.write(0x01);
  Wire.write(0x20);//setting range to +/- 1.3 gauss.
  Wire.endTransmission(true);  
}

void getScaledVal(){
    Magnetometer_ScaledVal[XAXIS]*=scaleVal;
    Magnetometer_ScaledVal[YAXIS]*=scaleVal;
    Magnetometer_ScaledVal[ZAXIS]*=scaleVal;
}

void getHeading(){
  heading=atan2(Magnetometer_ScaledVal[YAXIS]/Magnetometer_ScaledVal[XAXIS])*180/PI;
 
  heading+=declination_Angle;
  
  if(heading<0)
   heading+=2*PI;
  if(heading>2*PI)
   heading-=2*PI;
}
